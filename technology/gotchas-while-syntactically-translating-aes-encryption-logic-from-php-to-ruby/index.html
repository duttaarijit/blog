<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Gotcha's while syntactically translating AES encryption logic from PHP to Ruby &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="ruby, PHP, AES, Cryptography, Encryption, Decryption">

<!-- Twitter Cards -->
    <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Gotcha's while syntactically translating AES encryption logic from PHP to Ruby">
<meta name="twitter:description" content=" Attempting to syntactically translate PHP code, that dealt with AES encryption logic, into Ruby stumped our Payment Gateway Service provider">
<meta name="twitter:site" content="@elitmus">

    

    

    
        
            <meta name="twitter:creator" content="@surendrabobba">
        
    

    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/blog_logo_taglinedorange.png"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Gotcha's while syntactically translating AES encryption logic from PHP to Ruby">
<meta property="og:description" content="Attempting to syntactically translate PHP code, that dealt with AES encryption logic, into Ruby stumped our Payment Gateway Service provider">
<meta property="og:url" content="/blog/technology/gotchas-while-syntactically-translating-aes-encryption-logic-from-php-to-ruby/">

<meta property="og:site_name" content="eLitmus Blog">







<link rel="canonical" href="https://www.elitmus.com/blog/technology/gotchas-while-syntactically-translating-aes-encryption-logic-from-php-to-ruby/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">
<link rel="stylesheet" href="/blog/assets/css/main.min.css">
<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css"/>

<link rel="stylesheet" href="/blog/assets/css/customize.css">

<!-- <link rel="stylesheet" href="/blog/assets/css/demo.css"> -->

<link rel="stylesheet" href="/blog/assets/css/forkit.css">



</head>

<body id="post">


  <header class="headroom">
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/blog/"><img src="/blog/images/blog_logo_taglinedorange.png" alt="eLitmus Blog logo"/></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav navbar-left">
        <li>
          <div class="dropdown search-box-margin">
            <div class="input-group">
                
                
   
                <input data-toggle="dropdown" placeholder="Search...." id="search-box" class="input-sm search-input">
                <div class="dropdown-menu list-group" id="search-dropdown" >
                  <a role='presentation' class='search-results list-group-item'> Type more.... </a>
                </div>
            </div>
          </div>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li>
            
              <a href="/blog/"><i class="fa fa-home"></i> Home</a>
             
          </li>
          
          <li>
            
              <a href="/blog/posts/"><i class="fa fa-file-text-o"></i> Posts</a>
             
          </li>
          
          <li>
            
              <a href="//www.elitmus.com/"><i class="el el-elitmuslogo"></i> eLitmus</a>
             
          </li>
          
          <li><a href="/blog/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss"></i> Feed</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>






<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> --><!-- /.search-results -->
    <!-- </div> --><!-- /.search-form -->
  <!-- </div> --><!-- ./search-wrapper -->
<!--  --> 





  

  <div class="container-fluid">

  <div class="row">


    
    <div class="col-md-2">

    </div>
      <div class="col-md-8">
        

        <div id="main" role="main" class="marginal">
          <article class="hentry">
            
            <div >
              <header>

                <span class="entry-tags">
                  
                    <a href="/blog/tags/#ruby" title="Pages tagged ruby">ruby</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#PHP" title="Pages tagged PHP">PHP</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#AES" title="Pages tagged AES">AES</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#Cryptography" title="Pages tagged Cryptography">Cryptography</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#Encryption" title="Pages tagged Encryption">Encryption</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#Decryption" title="Pages tagged Decryption">Decryption</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
  
    <span class="social-share-facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.elitmus.com/blog/technology/gotchas-while-syntactically-translating-aes-encryption-logic-from-php-to-ruby/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square fa-lg"></i> Like</a>
    </span>&nbsp;&nbsp;
    <span class="social-share-twitter">
       <a href="https://twitter.com/share?hashtags=technology&text=Gotcha's while syntactically translating AES encryption logic from PHP to Ruby&via=elitmus" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square  fa-lg"></i></i> Tweet</a>
    </span>&nbsp;&nbsp;
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Gotcha's while syntactically translating AES encryption logic from PHP to Ruby</h1>
                
              </header>
            </div>
           
            <div>
                <div>
                  <span class='label label-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
                </div>
              
                <div class='pull-left date-show'>
                  <span class="entry-date date published"><time datetime="2014-05-25T00:00:00+05:30"><i class="fa fa-calendar"></i> May 25, 2014</time></span>&nbsp;

                    
                </div>
                <div class='pull-right date-show'>
                  <span>
                    <a href="/blog/technology/gotchas-while-syntactically-translating-aes-encryption-logic-from-php-to-ruby/" rel="bookmark" title="Gotcha's while syntactically translating AES encryption logic from PHP to Ruby">
                      <i class="fa fa-link"></i> Permalink
                    </a>
                  </span>
                </div>
                <br/>
                <div class="panel panel-default">
                  <div class="panel-heading ">
                    <h3 class="panel-title">TL;DR</h3>
                  </div>
                  <div class="panel-body">
                    <aside>Attempting to syntactically translate PHP code, that dealt with AES encryption logic, into Ruby stumped our Payment Gateway Service provider</aside>
                  </div>
                </div>

                  
                
                <div class="post-content-justify">
                  <p>Our Payment Gateway service provider recently launched a new platform with some nice-to-have features. We wanted those features and so we decided to migrate. Being one of the earliest adopters of the new platform, there was no integration kit available. We had to build it ourselves. Not a problem. Since we are a Ruby On Rails shop, we built our own Ruby integration kit. All went well and we pushed it to production.</p>

<p>A month or two later, we got an email from our gateway provider seeking our help with writing the <code>encryption</code> and <code>decryption</code> logic for the Ruby integration kit they were developing. We were a little surprised, because we noticed they had already published integration kits for PHP, Python, JAVA etc. How difficult can it be to translate that to Ruby?</p>

<p>Turns out, syntactic transalation of code from one programming language to another does not always work. A slightly more deeper knowledge helps. We could almost guess where they were getting stuck.</p>

<p>Before we get to the story, some backgroung on the encryption algo will add clarity.</p>

<p>For secure communication between our server and the gateway, the prescribed cipher was AES, specifically symmetric-key block cipher with a 128 bit secret key in CBC mode. Since OpenSSL already implements this algo and is avaliable on almost all platforms, most programming languages just bundle a wrapper for OpenSSL.</p>

<p>So if its the same OpenSSL that the wrappers call, why couldn’t the gateway service provider translate their own PHP code to Ruby?</p>

<h3 id="here-is-why">Here is why:</h3>

<p>AES works by breaking the plain text (the text to be encrypted) into blocks of 128 bits (or 16 bytes). In CBC mode, each block is XORed with the key to get cipher text of that block. The cipher text of the previous block is used for encrypting the next block… so on and so forth, until all the blocks are encrypted.</p>

<p>Note that the length of the cipher text will be exactly same as that of the plain text.</p>

<p>The problem occures with the last block. If the length of the plain text is not a multiple of 128. the last block will be shorter than 128 bits. Since the algo can work only on blocks of 128 bits, It is a common practice to pad the last block so that it becomes equal to 128 bits in lenght. This padding is subsequently discarded after decryption.</p>

<p><strong>Note:</strong> The actual algo is more complicated than this. We have deliberately left out details that are not relevent for this post.</p>

<p>This is the encryption method in the PHP integration kit published by the gateway service provider</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php"><span></span><span class="lineno"> 1 </span><span class="x">function encrypt($plainText,$key)</span>
<span class="lineno"> 2 </span><span class="x">{</span>
<span class="lineno"> 3 </span><span class="x">  $secretKey = hextobin(md5($key));</span>
<span class="lineno"> 4 </span><span class="x">  $initVector = &quot;...&quot;;</span>
<span class="lineno"> 5 </span><span class="x">  $openMode = mcrypt_module_open(MCRYPT_RIJNDAEL_128, &#39;&#39;,&#39;cbc&#39;, &#39;&#39;);</span>
<span class="lineno"> 6 </span><span class="x">  $blockSize = mcrypt_get_block_size(MCRYPT_RIJNDAEL_128, &#39;cbc&#39;);</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="x">  $plainPad = pkcs5_pad($plainText, $blockSize);  //  &lt;---- Padding</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="x">  if (mcrypt_generic_init($openMode, $secretKey, $initVector) != -1) </span>
<span class="lineno">11 </span><span class="x">  {</span>
<span class="lineno">12 </span><span class="x">    $encryptedText = mcrypt_generic($openMode, $plainPad);</span>
<span class="lineno">13 </span><span class="x">    mcrypt_generic_deinit($openMode);      </span>
<span class="lineno">14 </span><span class="x">  } </span>
<span class="lineno">15 </span><span class="x">  return bin2hex($encryptedText);</span>
<span class="lineno">16 </span><span class="x">}</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span><span class="x">// Padding method</span>
<span class="lineno">19 </span><span class="x">function pkcs5_pad ($plainText, $blockSize)</span>
<span class="lineno">20 </span><span class="x">{</span>
<span class="lineno">21 </span><span class="x">  // padding logic here</span>
<span class="lineno">22 </span><span class="x">}</span></code></pre></figure>

<p>And here is the same implemented in Ruby</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="lineno">1 </span><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">plain_text</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="lineno">2 </span>    <span class="n">secret_key</span>     <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">digest</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="lineno">3 </span>    <span class="n">cipher</span>         <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Cipher</span><span class="o">::</span><span class="no">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="ss">:CBC</span><span class="p">)</span>
<span class="lineno">4 </span>    <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span>
<span class="lineno">5 </span>    <span class="n">cipher</span><span class="o">.</span><span class="n">key</span>     <span class="o">=</span> <span class="n">secret_key</span>
<span class="lineno">6 </span>    <span class="n">cipher</span><span class="o">.</span><span class="n">iv</span>      <span class="o">=</span> <span class="no">INIT_VECTOR</span>
<span class="lineno">7 </span>    <span class="n">encrypted_text</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span> <span class="o">+</span> <span class="n">cipher</span><span class="o">.</span><span class="n">final</span>
<span class="lineno">8 </span>    <span class="k">return</span> <span class="p">(</span><span class="n">encrypted_text</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;H*&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">first</span>
<span class="lineno">9 </span><span class="k">end</span></code></pre></figure>

<p>Notice any difference?</p>

<p>It turns out that, unlike in Python, PHP and few other languages, Ruby wrapper for OpenSSL automatically takes care of padding (default behaviour). This is clearly mentioned in the <a href="http://ruby-doc.org/stdlib-2.0/libdoc/openssl/rdoc/OpenSSL/Cipher.html#method-i-final">documentation</a>. For some reason, techies at our gateway service provider overlooked this and hit a dead-end.</p>

<p>By the they, they were gracious enough to acknowledge our contribution in their Ruby Integration Kit (accessible only to their subscribers)</p>

<p>But We have open sourced our code here ‘<a href="https://github.com/elitmus/cca_crypto">cca_crypto</a>’. We have plans of make this into a complete package - with view generators etc., and publish this as a rubygem. We shall gladly accept any pull request!</p>


                </div>
                <div class="entry-tags">
                  <div class=' social-sharing pull-right'>        
  
    <span class="social-share-facebook">
      <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.elitmus.com/blog/technology/gotchas-while-syntactically-translating-aes-encryption-logic-from-php-to-ruby/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square fa-lg"></i> Like</a>
    </span>&nbsp;&nbsp;
    <span class="social-share-twitter">
       <a href="https://twitter.com/share?hashtags=technology&text=Gotcha's while syntactically translating AES encryption logic from PHP to Ruby&via=elitmus" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square  fa-lg"></i></i> Tweet</a>
    </span>&nbsp;&nbsp;
     
</div>
                </div>
                <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  
    
      <div class="panel-body">
        <div class="container-fluid">
          <div class="row">
            <div class="col-xs-6 col-md-4">
              <center>
                <img src="/blog/images/surendra.jpg" alt="Surendranath Bobba photo" class="author-photo img-circle img-responsive"/>
                <span class="author vcard"><span class="fn">Surendranath Bobba</span></span>

                <div class="nav-icon-size-reduce social-icons">
                  
                    <a href="http://twitter.com/surendrabobba"  title="Surendranath Bobba on Twitter"  target="_blank"><i class="fa fa-twitter "></i></a>
                  
                  
                  
                  

                  
                    <a href="http://linkedin.com/in/bobbasurendra" title="Surendranath Bobba on LinkedIn" target="_blank"><i class="fa fa-linkedin "></i></a>
                  

                  

                  

                  

                  
                    <a href="http://github.com/domitian" title="Surendranath Bobba on Github" target="_blank"><i class="fa fa-github "></i></a>
                  

                     
                </div><!-- /.social-icons -->
              </center>
            </div>

            <!-- Add the extra clearfix for only the required viewport -->
            <div class="clearfix visible-xs"></div>

            <div class="col-md-8">
              
                <span class="author-bio">Surendra is a member of technology team at eLitmus. He is passionate about all things Ancient Rome. Likes to code in javascript and exploring Golang.</span>
              
            </div>
          </div>
        </div>
      </div>

  

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/gotchas-while-syntactically-translating-aes-encryption-logic-from-php-to-ruby/'
                   };


  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>
            <nav class="navbar nav-justified" role="navigation">
              <ul class="pager">
                
                  <li class="previous showElem"><a href="/blog/technology/setting-up-amazon-rds-as-a-slave-to-a-self-managed-mysql-server/" title="Setting Up Amazon RDS as a Slave to a self-managed MySQL server">&larr;<span class="showPrevNex"> Previous </span> </a></li>
                
                
                  <li class="next showElem"><a href="/blog/technology/using-monit-to-get-email-alert-on-unauthorized-login/" title="Using Monit to get email alert on unauthorized login"> <span class='showPrevNex'> Next </span> &rarr; </a></li>
                
              </ul>
            </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a class='footer-text' href="/terms_of_use/">Terms of Use</a> &middot; <a  class='footer-text' href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-707704-1', 'elitmus.com');
	  ga('send', 'pageview');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/blog/assets/js/vendor/jquery-2.1.1.min.js"><\/script>')</script>
<!-- end of jquery -->
<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>
  

  </body>
</html>
